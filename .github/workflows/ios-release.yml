name: iOS Release Build

on:
  push:
    tags:
      - 'ios-v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        type: string

jobs:
  build-and-release:
    name: Build and Release iOS App
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
      
      - name: Show Xcode version
        run: xcodebuild -version
      
      - name: Install xcodegen
        run: |
          if ! command -v xcodegen &> /dev/null; then
            brew install xcodegen
          fi
        continue-on-error: true
      
      - name: Generate Xcode project
        working-directory: ios
        run: |
          if command -v xcodegen &> /dev/null && [ -f "xcodegen.yml" ]; then
            xcodegen generate
            echo "âœ… Project generated"
          else
            echo "âš ï¸  xcodegen not available, using existing project"
          fi
        continue-on-error: true
      
      - name: Setup Apple Developer certificates
        if: env.APPLE_CERTIFICATE_BASE64 != ''
        env:
          APPLE_CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          if [ -n "$APPLE_CERTIFICATE_BASE64" ]; then
            echo "Setting up certificates..."
            # Create variables
            CERTIFICATES_PATH="$RUNNER_TEMP/certificates"
            KEYCHAIN_PATH="$RUNNER_TEMP/app-signing.keychain-db"
            
            # Create certificates directory
            mkdir -p "$CERTIFICATES_PATH"
            
            # Decode certificate
            echo "$APPLE_CERTIFICATE_BASE64" | base64 --decode > "$CERTIFICATES_PATH/certificate.p12"
            
            # Create temporary keychain
            security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
            security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
            security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
            
            # Import certificate
            security import "$CERTIFICATES_PATH/certificate.p12" -P "$APPLE_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH" || true
            security list-keychain -d user -s "$KEYCHAIN_PATH"
            
            echo "âœ… Certificates set up"
          else
            echo "â„¹ï¸  No certificates provided, will build without signing"
          fi
        continue-on-error: true
      
      - name: Build for iOS Device
        working-directory: ios
        env:
          DEVELOPER_TEAM_ID: ${{ secrets.DEVELOPER_TEAM_ID }}
          PROVISIONING_PROFILE_SPECIFIER: ${{ secrets.PROVISIONING_PROFILE_SPECIFIER }}
        run: |
          if [ -f "LotteryApp.xcodeproj/project.pbxproj" ]; then
            echo "ðŸ”¨ Building for iOS device..."
            
            # Build configuration
            SCHEME="LotteryApp"
            CONFIGURATION="Release"
            
            if [ -n "$DEVELOPER_TEAM_ID" ]; then
              echo "Building with code signing..."
              xcodebuild clean archive \
                -project LotteryApp.xcodeproj \
                -scheme "$SCHEME" \
                -configuration "$CONFIGURATION" \
                -archivePath "$RUNNER_TEMP/LotteryApp.xcarchive" \
                -sdk iphoneos \
                CODE_SIGN_IDENTITY="iPhone Developer" \
                DEVELOPMENT_TEAM="$DEVELOPER_TEAM_ID" \
                PROVISIONING_PROFILE_SPECIFIER="$PROVISIONING_PROFILE_SPECIFIER" \
                CODE_SIGNING_REQUIRED=YES \
                CODE_SIGNING_ALLOWED=YES
            else
              echo "Building without code signing (for simulator only)..."
              xcodebuild clean build \
                -project LotteryApp.xcodeproj \
                -scheme "$SCHEME" \
                -configuration "$CONFIGURATION" \
                -sdk iphonesimulator \
                CODE_SIGNING_REQUIRED=NO \
                CODE_SIGNING_ALLOWED=NO
            fi
            
            echo "âœ… Build completed"
          else
            echo "âš ï¸  Xcode project not found"
            exit 1
          fi
        continue-on-error: true
      
      - name: Export IPA
        if: env.DEVELOPER_TEAM_ID != ''
        working-directory: ios
        env:
          DEVELOPER_TEAM_ID: ${{ secrets.DEVELOPER_TEAM_ID }}
        run: |
          if [ -f "$RUNNER_TEMP/LotteryApp.xcarchive" ]; then
            echo "ðŸ“¦ Exporting IPA..."
            
            # Create export options plist
            cat > "$RUNNER_TEMP/ExportOptions.plist" << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>ad-hoc</string>
              <key>teamID</key>
              <string>$DEVELOPER_TEAM_ID</string>
          </dict>
          </plist>
          EOF
            
            xcodebuild -exportArchive \
              -archivePath "$RUNNER_TEMP/LotteryApp.xcarchive" \
              -exportOptionsPlist "$RUNNER_TEMP/ExportOptions.plist" \
              -exportPath "$RUNNER_TEMP/export"
            
            echo "âœ… IPA exported"
          else
            echo "âš ï¸  Archive not found, skipping IPA export"
          fi
        continue-on-error: true
      
      - name: Upload IPA artifact
        if: env.DEVELOPER_TEAM_ID != ''
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: ${{ runner.temp }}/export/*.ipa
          if-no-files-found: ignore
          retention-days: 30
      
      - name: Create installation instructions
        run: |
          cat > "$RUNNER_TEMP/INSTALL_INSTRUCTIONS.md" << 'EOF'
          # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° iOS Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ð½Ð° ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾
          
          ## Ð¡Ð¿Ð¾ÑÐ¾Ð± 1: TestFlight (Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´ÑƒÐµÑ‚ÑÑ)
          
          1. Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ IPA Ð² App Store Connect
          2. Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ñ‰Ð¸ÐºÐ¾Ð² Ð² TestFlight
          3. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ TestFlight Ð½Ð° iPhone
          4. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ð¿Ñ€Ð¸Ð³Ð»Ð°ÑˆÐµÐ½Ð¸Ðµ Ð¸Ð· TestFlight
          
          ## Ð¡Ð¿Ð¾ÑÐ¾Ð± 2: Ad Hoc ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°
          
          ### Ð¢Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ:
          - IPA Ñ„Ð°Ð¹Ð» Ð¸Ð· Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð²
          - UDID ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð° Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½ Ð² provisioning profile
          - Apple Configurator 2 Ð¸Ð»Ð¸ Xcode
          
          ### Ð§ÐµÑ€ÐµÐ· Apple Configurator:
          1. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Apple Configurator 2 Ð½Ð° Mac
          2. ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ iPhone Ðº Mac
          3. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Apple Configurator
          4. Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾
          5. ÐŸÐµÑ€ÐµÑ‚Ð°Ñ‰Ð¸Ñ‚Ðµ IPA Ñ„Ð°Ð¹Ð» Ð² Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
          
          ### Ð§ÐµÑ€ÐµÐ· Xcode:
          1. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Xcode â†’ Window â†’ Devices and Simulators
          2. ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ iPhone
          3. Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾
          4. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ "+" Ð¸ Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ IPA Ñ„Ð°Ð¹Ð»
          
          ## Ð¡Ð¿Ð¾ÑÐ¾Ð± 3: Ð§ÐµÑ€ÐµÐ· Ð²ÐµÐ±-ÑÐ°Ð¹Ñ‚ (Enterprise)
          
          Ð•ÑÐ»Ð¸ Ñƒ Ð²Ð°Ñ Enterprise Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚:
          1. Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ IPA Ð½Ð° Ð²ÐµÐ±-ÑÐµÑ€Ð²ÐµÑ€
          2. Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ manifest.plist
          3. Ð Ð°Ð·Ð¼ÐµÑÑ‚Ð¸Ñ‚Ðµ ÑÑÑ‹Ð»ÐºÑƒ Ð´Ð»Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸
          
          ## Ð¡Ð¿Ð¾ÑÐ¾Ð± 4: AltStore / Sideloadly (Ð´Ð»Ñ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸)
          
          Ð”Ð»Ñ Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð±ÐµÐ· Apple Developer:
          1. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ AltStore Ð¸Ð»Ð¸ Sideloadly
          2. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ð±ÐµÑÐ¿Ð»Ð°Ñ‚Ð½Ñ‹Ð¹ Apple ID
          3. ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡ÐµÐ½Ð¸Ðµ: 7 Ð´Ð½ÐµÐ¹, Ð½ÑƒÐ¶Ð½Ð¾ Ð¿ÐµÑ€ÐµÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°Ñ‚ÑŒ
          EOF
          
          cat "$RUNNER_TEMP/INSTALL_INSTRUCTIONS.md"
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-info
          path: ${{ runner.temp }}/INSTALL_INSTRUCTIONS.md
          if-no-files-found: ignore
          retention-days: 30

