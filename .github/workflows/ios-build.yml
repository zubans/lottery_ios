name: iOS Build

on:
  push:
    branches: [ master, main ]
    paths:
      - 'ios/**'
  pull_request:
    branches: [ master, main ]
    paths:
      - 'ios/**'
  workflow_dispatch:

jobs:
  build:
    name: Build iOS App
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.0.app/Contents/Developer || sudo xcode-select -s /Applications/Xcode_15.1.app/Contents/Developer || sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer || sudo xcode-select -s /Applications/Xcode_15.3.app/Contents/Developer || sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer || sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
      
      - name: Show Xcode version
        run: xcodebuild -version
      
      - name: Show Swift version
        run: swift --version
      
      - name: List available simulators
        run: xcrun simctl list devices available
      
      - name: Install xcodegen (if available)
        run: |
          if command -v xcodegen &> /dev/null; then
            echo "‚úÖ xcodegen found"
            xcodegen --version
          else
            echo "‚ÑπÔ∏è  xcodegen not installed (will try to install via brew)"
            brew install xcodegen || echo "‚ö†Ô∏è  Could not install xcodegen"
          fi
        continue-on-error: true
      
      - name: Generate Xcode project with xcodegen
        working-directory: ios
        run: |
          if command -v xcodegen &> /dev/null && [ -f "xcodegen.yml" ]; then
            echo "Generating Xcode project with xcodegen..."
            xcodegen generate
            echo "‚úÖ Project generated successfully"
          else
            echo "‚ÑπÔ∏è  Skipping xcodegen generation"
            echo "   - xcodegen available: $(command -v xcodegen &> /dev/null && echo 'yes' || echo 'no')"
            echo "   - xcodegen.yml exists: $([ -f 'xcodegen.yml' ] && echo 'yes' || echo 'no')"
          fi
        continue-on-error: true
      
      - name: Build for iOS Simulator
        working-directory: ios
        run: |
          if [ -f "LotteryApp.xcodeproj/project.pbxproj" ]; then
            echo "üî® Building iOS app..."
            xcodebuild clean build \
              -project LotteryApp.xcodeproj \
              -scheme LotteryApp \
              -sdk iphonesimulator \
              -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO \
              | xcpretty || xcodebuild clean build \
              -project LotteryApp.xcodeproj \
              -scheme LotteryApp \
              -sdk iphonesimulator \
              -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO
            echo "‚úÖ Build completed"
          else
            echo "‚ö†Ô∏è  Skipping build - Xcode project not found"
            echo ""
            echo "To enable full build:"
            echo "1. Install xcodegen: brew install xcodegen"
            echo "2. Run: cd ios && xcodegen generate"
            echo "3. Commit: git add LotteryApp.xcodeproj && git commit"
          fi
        continue-on-error: true
      
      - name: Validate Swift files structure
        working-directory: ios
        run: |
          echo "Checking Swift files..."
          swift_files=$(find LotteryApp -name "*.swift" -type f 2>/dev/null | wc -l)
          echo "Found $swift_files Swift files"
          
          if [ "$swift_files" -gt 0 ]; then
            echo "‚úÖ Swift files found"
            find LotteryApp -name "*.swift" -type f | head -10
          else
            echo "‚ö†Ô∏è  No Swift files found in LotteryApp/"
          fi
        continue-on-error: true
      
      - name: Archive build artifacts
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-logs
          path: |
            ios/*.log
            ios/build/
          if-no-files-found: ignore
          retention-days: 7

